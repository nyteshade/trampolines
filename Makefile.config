# Makefile.config - Configuration for SSL/OpenSSL paths
# This file can be customized for different systems

# Detect OS
UNAME_S := $(shell uname -s)
UNAME_R := $(shell uname -r)

# Default SSL settings
SSL_ENABLED ?= yes
OPENSSL_PREFIX ?= /usr

# Detect if we're on older macOS that might use MacPorts
ifeq ($(UNAME_S),Darwin)
    # Check macOS version (Darwin kernel version)
    DARWIN_MAJOR := $(shell echo $(UNAME_R) | cut -d. -f1)
    
    # Darwin 8.x = Tiger (10.4)
    # Darwin 9.x = Leopard (10.5) 
    # Darwin 10.x = Snow Leopard (10.6)
    ifeq ($(shell test $(DARWIN_MAJOR) -le 9 && echo old),old)
        # Older macOS - check for MacPorts OpenSSL
        ifneq ($(wildcard /opt/local/include/openssl/ssl.h),)
            OPENSSL_PREFIX = /opt/local
            $(info Detected MacPorts OpenSSL at $(OPENSSL_PREFIX))
        endif
    else
        # Modern macOS - check for Homebrew OpenSSL
        ifneq ($(wildcard /opt/homebrew/opt/openssl/include/openssl/ssl.h),)
            OPENSSL_PREFIX = /opt/homebrew/opt/openssl
            $(info Detected Homebrew OpenSSL at $(OPENSSL_PREFIX))
        else ifneq ($(wildcard /usr/local/opt/openssl/include/openssl/ssl.h),)
            OPENSSL_PREFIX = /usr/local/opt/openssl
            $(info Detected Homebrew OpenSSL at $(OPENSSL_PREFIX))
        endif
    endif
endif

# Linux distributions
ifeq ($(UNAME_S),Linux)
    # Most Linux distros have OpenSSL in standard locations
    ifneq ($(wildcard /usr/include/openssl/ssl.h),)
        OPENSSL_PREFIX = /usr
    else ifneq ($(wildcard /usr/local/include/openssl/ssl.h),)
        OPENSSL_PREFIX = /usr/local
    endif
endif

# Build SSL flags
ifeq ($(SSL_ENABLED),yes)
    SSL_CFLAGS = -I$(OPENSSL_PREFIX)/include
    SSL_LDFLAGS = -L$(OPENSSL_PREFIX)/lib -lssl -lcrypto
    
    # Add rpath for non-standard locations
    ifneq ($(OPENSSL_PREFIX),/usr)
        ifeq ($(UNAME_S),Darwin)
            SSL_LDFLAGS += -Wl,-rpath,$(OPENSSL_PREFIX)/lib
        else
            SSL_LDFLAGS += -Wl,-rpath=$(OPENSSL_PREFIX)/lib
        endif
    endif
else
    SSL_CFLAGS = -DNO_SSL_SUPPORT
    SSL_LDFLAGS =
endif

# Export for use in main Makefile
export SSL_ENABLED
export SSL_CFLAGS
export SSL_LDFLAGS

# Allow override from environment or command line
# Examples:
#   make OPENSSL_PREFIX=/opt/local            # MacPorts
#   make OPENSSL_PREFIX=/usr/local            # Custom build
#   make SSL_ENABLED=no                       # Disable SSL
#   make OPENSSL_PREFIX=/opt/openssl-1.1.1    # Specific version

# Print configuration (can be called with make -f Makefile.config show)
show:
	@echo "SSL Configuration:"
	@echo "  SSL_ENABLED    = $(SSL_ENABLED)"
	@echo "  OPENSSL_PREFIX = $(OPENSSL_PREFIX)"
	@echo "  SSL_CFLAGS     = $(SSL_CFLAGS)"
	@echo "  SSL_LDFLAGS    = $(SSL_LDFLAGS)"
	@echo ""
	@echo "System Info:"
	@echo "  OS             = $(UNAME_S)"
	@echo "  Kernel         = $(UNAME_R)"
ifeq ($(UNAME_S),Darwin)
	@echo "  Darwin Major   = $(DARWIN_MAJOR)"
endif
	@echo ""
	@echo "To override, use:"
	@echo "  make OPENSSL_PREFIX=/path/to/openssl"
	@echo "  make SSL_ENABLED=no"

.PHONY: show